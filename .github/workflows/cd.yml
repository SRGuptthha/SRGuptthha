name: Boomi CD

on:
  workflow_dispatch:
    inputs:
      version:
        description: 'Artifact Version to deploy'
        required: true

permissions:
  contents: read

jobs:
  deploy-dev:
    runs-on: ubuntu-latest
    steps:
      - name: Download artifact
        uses: actions/download-artifact@v4
        with:
          name: boomi-package-${{ github.event.inputs.version }}

      - name: Prepare Boomi auth
        id: auth
        run: |
          echo "token=$(echo -n '${{ secrets.BOOMI_USERNAME }}:${{ secrets.BOOMI_PASSWORD }}' | base64)" >> $GITHUB_OUTPUT

      - name: Deploy to Dev
        run: |
          curl -s -X POST \
            -H "Authorization: Basic ${{ steps.auth.outputs.token }}" \
            -H "Content-Type: application/json" \
            -d @.boomi/deploy_dev.json \
            "https://api.boomi.com/api/rest/v1/${{ secrets.BOOMI_ACCOUNT_ID }}/Deployment"

      - name: Notify
        run: echo "Deployed to Dev"

  approve-qa:
    needs: [deploy-dev]
    runs-on: ubuntu-latest
    environment:
      name: QA
      url: https://manage.boomi.com
    steps:
      - name: Manual approval gate
        run: echo "Awaiting QA approval (use Environment protection rules)."

  deploy-qa:
    needs: [approve-qa]
    runs-on: ubuntu-latest
    steps:
      - name: Prepare Boomi auth
        id: auth
        run: |
          echo "token=$(echo -n '${{ secrets.BOOMI_USERNAME }}:${{ secrets.BOOMI_PASSWORD }}' | base64)" >> $GITHUB_OUTPUT

      - name: Deploy to QA
        run: |
          curl -s -X POST \
            -H "Authorization: Basic ${{ steps.auth.outputs.token }}" \
            -H "Content-Type: application/json" \
            -d @.boomi/deploy_qa.json \
            "https://api.boomi.com/api/rest/v1/${{ secrets.BOOMI_ACCOUNT_ID }}/Deployment"

  approve-prod:
    needs: [deploy-qa]
    runs-on: ubuntu-latest
    environment:
      name: PROD
    steps:
      - name: CAB/Change ticket reference
        run: echo "Ensure change ticket is recorded."

  deploy-prod:
    needs: [approve-prod]
    runs-on: ubuntu-latest
    steps:
      - name: Prepare Boomi auth
        id: auth
        run: |
          echo "token=$(echo -n '${{ secrets.BOOMI_USERNAME }}:${{ secrets.BOOMI_PASSWORD }}' | base64)" >> $GITHUB_OUTPUT

      - name: Deploy to Prod
        run: |
          curl -s -X POST \
            -H "Authorization: Basic ${{ steps.auth.outputs.token }}" \
            -H "Content-Type: application/json" \
            -d @.boomi/deploy_prod.json \
            "https://api.boomi.com/api/rest/v1/${{ secrets.BOOMI_ACCOUNT_ID }}/Deployment"

      - name: Tag release
        run: |
          git fetch --tags
          git tag -a "release-${{ github.event.inputs.version }}" -m "Boomi prod deploy"
          git push origin "release-${{ github.event.inputs.version }}"
